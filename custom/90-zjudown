#!/bin/sh
# Auto reconnect ZJU L2TP. Put it in /etc/hotplug.d/iface/
([ ${INTERFACE} = "zju" ] && [ ${ACTION} = "ifdown" ]) || exit 0
# Don't disturb if there's no configured password
[ -n $(uci get network.zju.password) ] || exit 0

CheckZJU() {
    ZJU_DOWN="0"
    # Only works when WAN DHCP is fine
    if (ifstatus wan | grep -q '"up": true') && (ifstatus zju | grep -q '"up": false'); then
        ZJU_DOWN="1"
    fi
    return ${ZJU_DOWN}
}

# Wait enough time in case of the chaos at boot
logger -t zjudown "ZJU L2TP seems down, wait for 20 seconds..."
sleep 20
TrialCount=0
MAXTRIALNUM=3
CheckZJU; ZJU_DOWN=$?

# Tries at most ${MAXTRIALNUM} times
while [ ${ZJU_DOWN} = "1" ] && [ ${TrialCount} -lt ${MAXTRIALNUM} ]; do
    TrialCount=$(expr ${TrialCount} + 1)
    logger -t zjudown "Start No.${TrialCount} trial..."
    ifup zju
    logger -t zjudown "Wait for 15 seconds..."
    sleep 15
    CheckZJU; ZJU_DOWN=$?
done

if [ ${TrialCount} -ge ${MAXTRIALNUM} ]; then
    logger -t zjudown "All ${TrialCount} trials failed. Stop working."
fi

if [ ${ZJU_DOWN} = "0" ]; then
    logger -t zjudown "ZJU L2TP is working now."
fi

exit 0
